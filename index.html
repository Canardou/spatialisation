<html>
    <head>
        <script type="text/javascript" src="jsfeat.js"></script>
    </head>
    <body>
        <video id="file" autoplay loop>
            <source src=IRIT01.webm type=video/webm>
        </video>
        <p><canvas id="canvas"></canvas></p>
        <script type="text/javascript">
        "use strict";
        var file = document.getElementById('file');
        var canvas = document.getElementById('canvas');
        var videoStream = null;
        var preLog = document.getElementById('preLog');
        
        function log(text)
        {
        	if (preLog) preLog.textContent += ('\n' + text);
        	else alert(text);
        }
        
        window.onload=function(){
            window.requestAnimationFrame(snapshot);
        }
            
        function snapshot()
        {
        	canvas.width = file.videoWidth;
        	canvas.height = file.videoHeight;
        	
        	var ctx = canvas.getContext('2d');
        	ctx.drawImage(file, 0, 0);
        	try{
            	var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            	
                var pixels = imageData.data;
                 
                var gray_img = new jsfeat.matrix_t(canvas.width, canvas.height, jsfeat.U8_t | jsfeat.C1_t);
                var code = jsfeat.COLOR_RGBA2GRAY;
                jsfeat.imgproc.grayscale(imageData.data, canvas.width, canvas.height, gray_img, code);
                
                var data_u32 = new Uint32Array(imageData.data.buffer);
                var alpha = (0xff << 24);
                var i = gray_img.cols*gray_img.rows, pix = 0;
                while(--i >= 0) {
                    pix = gray_img.data[i];
                    data_u32[i] = alpha | (pix << 16) | (pix << 8) | pix;
                }

                ctx.putImageData(imageData, 0, 0);
                
        	}
        	catch (e){
        	    console.log(e)
        	}
            window.requestAnimationFrame(snapshot);
        }
        
        
        
        // crÃ©e un contexteaudio
        var contexteAudio = new (window.AudioContext || window.webkitAudioContext)();
        
        // create Oscillator node
        var oscillator = contexteAudio.createOscillator();
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(440, 0); // valeur en hertz
        oscillator.detune.setValueAtTime(0.2, 0);

        var gainNode = contexteAudio.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(contexteAudio.destination);
        gainNode.gain.setValueAtTime(0.1, contexteAudio.currentTime);
        
        //oscillator.start();
        oscillator.stop(contexteAudio.currentTime + 2);
        </script>
    </body>
</html>