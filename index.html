<html>
    <head>
        <script type="text/javascript" src="jsfeat.js"></script>
    </head>
    <body>
        <video id="file" autoplay loop style="display: none;">
            <source src=IRIT01.webm type=video/webm>
        </video>
        <p><canvas id="canvas"></canvas></p>
        <script type="text/javascript">
        /* global jsfeat */
        "use strict";
        var file = document.getElementById('file');
        var canvas = document.getElementById('canvas');
        var videoStream = null;
        
        var curr_img_pyr = new jsfeat.pyramid_t(3);
        var prev_img_pyr = new jsfeat.pyramid_t(3);
        var win_size = 20,
            max_iterations = 30,
            epsilon = 0.01,
            min_eigen = 0.001;
        
        var prev_xy = new Float32Array(100*2);
        var curr_xy = new Float32Array(100*2);
        var point_count = 100;
        var reset_point = 0;
        var point_status = new Uint8Array(100);
        var point_speed = new Float32Array(100);
        
        window.onload=function(){
            window.requestAnimationFrame(snapshot);
            curr_img_pyr.allocate(canvas.width, canvas.height, jsfeat.U8_t|jsfeat.C1_t);
            prev_img_pyr.allocate(canvas.width, canvas.height, jsfeat.U8_t|jsfeat.C1_t);
            for(var k=0; k<100; k++){
        	    var coords = {x:Math.floor(Math.random()*canvas.width), y:30+Math.floor(Math.random()*(canvas.height-60))}; 
                curr_xy[k<<1] = coords.x;
                curr_xy[(k<<1)+1] = coords.y;
            }
            
        }
            
        function snapshot()
        {
        	canvas.width = file.videoWidth;
        	canvas.height = file.videoHeight;
        	
    	    for(var i=0; i<100; i++){
    	        if((point_speed[i] == 0 && reset_point == 0) || point_status[i] == 0){
            	    var coords = {x:Math.floor(Math.random()*canvas.width), y:30+Math.floor(Math.random()*(canvas.height-60))}; 
                    curr_xy[i<<1] = coords.x;
                    curr_xy[(i<<1)+1] = coords.y;
    	        }
    	    }
        	reset_point = (reset_point+1)%60;
        	
        	var ctx = canvas.getContext('2d');
        	ctx.drawImage(file, 0, 0);
        	try{
            	var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            	
                var pixels = imageData.data;
                 
                var gray_img = new jsfeat.matrix_t(canvas.width, canvas.height, jsfeat.U8_t | jsfeat.C1_t);
                var code = jsfeat.COLOR_RGBA2GRAY;
                
                var _pyr = prev_img_pyr;
                prev_img_pyr = curr_img_pyr;
                curr_img_pyr = _pyr;
                var _pt_xy = prev_xy;
                prev_xy = curr_xy;
                curr_xy = _pt_xy;
                
                jsfeat.imgproc.grayscale(imageData.data, canvas.width, canvas.height, curr_img_pyr.data[0], code);
                
                curr_img_pyr.build(curr_img_pyr.data[0], true);
                jsfeat.optical_flow_lk.track(prev_img_pyr, curr_img_pyr, prev_xy, curr_xy, point_count, win_size, max_iterations, point_status, epsilon, min_eigen);
                
                var data_u32 = new Uint32Array(imageData.data.buffer);
                var alpha = (0xff << 24);
                var i = curr_img_pyr.data[0].cols*curr_img_pyr.data[0].rows, pix = 0;
                while(--i >= 0) {
                    pix = curr_img_pyr.data[0].data[i];
                    data_u32[i] = alpha | (pix << 16) | (pix << 8) | pix;
                }

                prune_oflow_points(ctx);
                
        	}
        	catch (e){
        	    console.log(e);
        	}
            window.requestAnimationFrame(snapshot);
        }

        function draw_circle(ctx, x, y, velocity, speed) {
            ctx.beginPath();
            ctx.beginPath();
            ctx.moveTo(x,y);
            ctx.lineTo(x+velocity.x,y+velocity.y);
            ctx.strokeStyle = "rgb(0,255,"+speed+")";
            ctx.stroke();
        }

        var sound_avg = 0;
        function prune_oflow_points(ctx) {
            var n = point_count;
            var i=0;
            var sound = 0;
            for(; i < n; ++i) {
                if(point_status[i] == 1) {
                    var velocity = {x:prev_xy[i<<1]-curr_xy[i<<1], y:prev_xy[(i<<1)+1]-curr_xy[(i<<1)+1]}
                    var speed = Math.floor(Math.sqrt(velocity.x*velocity.x + velocity.y*velocity.y));
                    speed = Math.min(Math.max(0,speed),255);
                    point_speed[i] = speed;
                    if(speed > 0){
                        sound = Math.max(sound,speed);
                    }
                    draw_circle(ctx, curr_xy[i<<1], curr_xy[(i<<1)+1], velocity, speed);
                }
            }
            sound_avg = (sound_avg*9 + sound)/10;
            gainNode.gain.setValueAtTime(sound_avg/128, contexteAudio.currentTime);
        }

        function relMouseCoords(event) {
            var totalOffsetX=0,totalOffsetY=0,canvasX=0,canvasY=0;
            var currentElement = this;

            do {
                totalOffsetX += currentElement.offsetLeft - currentElement.scrollLeft;
                totalOffsetY += currentElement.offsetTop - currentElement.scrollTop;
            } while(currentElement = currentElement.offsetParent)

            canvasX = event.pageX - totalOffsetX;
            canvasY = event.pageY - totalOffsetY;

            return {x:canvasX, y:canvasY};
        }
        HTMLCanvasElement.prototype.relMouseCoords = relMouseCoords;
        
        
        // crÃ©e un contexteaudio
        var contexteAudio = new (window.AudioContext || window.webkitAudioContext)();
        
        // create Oscillator node
        var oscillator = contexteAudio.createOscillator();
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(440, 0); // valeur en hertz
        oscillator.detune.setValueAtTime(0.2, 0);

        var gainNode = contexteAudio.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(contexteAudio.destination);
        gainNode.gain.setValueAtTime(0, contexteAudio.currentTime);
        
        oscillator.start();
        //oscillator.stop(contexteAudio.currentTime + 0.1);
        </script>
    </body>
</html>